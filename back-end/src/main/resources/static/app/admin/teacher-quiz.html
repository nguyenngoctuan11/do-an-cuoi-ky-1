<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tạo bài kiểm tra (Giảng viên)</title>
  <link rel="stylesheet" href="/app/app.css"/>
  <script type="module">
    import {mountNav, mountAdminMenu, mountAdminUser, api, token, requireAuth} from '/app/app-common.js';
    const el = id => document.getElementById(id);

    let currentCourse = null;
    let currentQuiz = null;

    const setMessage = (text='')=>{
      const box = el('msg');
      if(box) box.textContent = text;
    };

    async function loadCourses(){
      if(!requireAuth(['TEACHER','MANAGER'])) return;
      const list = await api('/api/teacher/courses/my');
      const sel = el('course');
      sel.innerHTML = '<option value="">-- Chọn khóa học --</option>' +
        (list||[]).map(c=>`<option value="${c.id}">#${c.id} | ${c.title} (${c.status})</option>`).join('');
    }

    async function onCourseChange(){
      currentCourse = Number(el('course').value)||null;
      currentQuiz = null;
      el('quizId').textContent = '-';
      setMessage('');
      if(currentCourse){ await loadQuizzes(currentCourse); }
      else{
        el('quizzes').innerHTML = '<tr><td colspan="5" class="muted">Chọn khóa học để xem danh sách đề</td></tr>';
      }
    }

    async function loadQuizzes(courseId){
      try{
        const list = await api(`/api/teacher/quizzes/course/${courseId}`);
        el('quizzes').innerHTML = (list||[]).map(q=>`<tr>
          <td>#${q.id}</td>
          <td>${q.title||''}</td>
          <td>${q.timeLimitSec||0}s</td>
          <td>${q.questions||0}</td>
          <td><button class="btn ghost choose" data-id="${q.id}">Chọn</button></td>
        </tr>`).join('') || '<tr><td colspan="5" class="muted">Chưa có bài kiểm tra nào</td></tr>';
        document.querySelectorAll('.choose').forEach(btn=>{
          btn.onclick = ()=>{
            currentQuiz = Number(btn.getAttribute('data-id'));
            el('quizId').textContent = `#${currentQuiz}`;
            setMessage(`Đang chỉnh sửa đề #${currentQuiz}`);
          };
        });
      }catch(e){
        setMessage('Lỗi tải danh sách đề: ' + (e.message||e));
      }
    }

    async function createQuiz(){
      if(!currentCourse){ alert('Chọn khóa học trước'); return; }
      const title = el('quizTitle').value.trim();
      const time = Number(el('quizTime').value||0);
      const shuffle = el('quizShuffle').checked;
      try{
        const res = await api('/api/teacher/quizzes', { method:'POST', body: JSON.stringify({ courseId: currentCourse, title, timeLimitSec: time, shuffle })});
        currentQuiz = res.id;
        el('quizId').textContent = `#${currentQuiz}`;
        setMessage(`Đã tạo đề #${currentQuiz}`);
        await loadQuizzes(currentCourse);
      }catch(e){
        setMessage('Lỗi tạo đề: ' + (e.message||e));
      }
    }

    async function addQuestion(){
      if(!currentQuiz){ alert('Chọn hoặc tạo đề trước'); return; }
      const text = el('qText').value.trim();
      const points = Number(el('qPoint').value||1);
      const opts = ['A','B','C','D'].map(k=>({ text: el('opt'+k).value.trim(), correct: el('correct'+k).checked }));
      if(!text){ alert('Nhập nội dung câu hỏi'); return; }
      if(!opts.some(o=>o.correct)){ alert('Chọn ít nhất 1 đáp án đúng'); return; }
      try{
        await api(`/api/teacher/quizzes/${currentQuiz}/questions`, { method:'POST', body: JSON.stringify({ text, points, options: opts })});
        el('qText').value = '';
        el('qPoint').value = 1;
        ['A','B','C','D'].forEach(k=>{ el('opt'+k).value=''; el('correct'+k).checked=false; });
        setMessage('Đã thêm câu hỏi mới');
        await loadQuizzes(currentCourse);
      }catch(e){
        setMessage('Lỗi thêm câu hỏi: ' + (e.message||e));
      }
    }

    async function upload(kind, inputId){
      const file = el(inputId).files[0];
      if(!file){ alert('Chọn file trước'); return; }
      const fd = new FormData();
      fd.append('file', file);
      const headers = token()? { Authorization:`Bearer ${token()}` } : {};
      const res = await fetch(`/api/upload/${kind}`, { method:'POST', headers, body: fd });
      const text = await res.text();
      let data; try{ data = text? JSON.parse(text): null; }catch{ data = null; }
      if(!res.ok){ alert((data && data.message) || res.statusText); return; }
      const url = data && data.url;
      if(!url){ alert('Không nhận được đường dẫn file'); return; }
      const area = el('qText');
      if(kind==='image'){
        area.value += `\n<img src="${url}" alt="" />\n`;
      }else{
        area.value += `\n<video src="${url}" controls></video>\n`;
      }
      setMessage('Đã chèn media vào câu hỏi');
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      mountNav('nav');
      mountAdminMenu('adminMenu','teacher-quiz');
      mountAdminUser('adminUserCard');
      loadCourses();
      el('course').addEventListener('change', onCourseChange);
      el('createQuiz').addEventListener('click', createQuiz);
      el('addQuestion').addEventListener('click', addQuestion);
      el('upImg').addEventListener('click', ()=>upload('image','mediaImage'));
      el('upVid').addEventListener('click', ()=>upload('video','mediaVideo'));
    });
  </script>
</head>
<body class="admin-body">
  <div class="admin-shell">
    <aside class="admin-sidebar">
      <div class="admin-brand">
        <span class="eyebrow">Ngân hàng đề</span>
        <strong>Tạo bài kiểm tra</strong>
        <p class="muted">Quản lý đề trắc nghiệm cho từng khóa học.</p>
      </div>
      <div id="adminUserCard" class="admin-user-card"></div>
      <nav id="adminMenu" class="admin-menu"></nav>
      <div class="admin-sidebar-footer">
        <a class="text-link" href="/app/index.html">← Về trang tổng quan</a>
      </div>
    </aside>
    <div class="admin-main">
      <div id="nav" data-variant="compact"></div>
      <main class="admin-content">
        <div class="admin-page-header">
          <p class="muted">Chọn khóa học để bắt đầu</p>
          <h1>Trình soạn đề</h1>
        </div>
        <div class="card">
          <h2>Danh sách đề theo khóa học</h2>
          <div class="row">
            <select id="course"></select>
            <div class="badge">Đề hiện tại: <span id="quizId">-</span></div>
          </div>
          <div style="overflow:auto;margin-top:16px">
            <table>
              <thead><tr><th>ID</th><th>Tiêu đề</th><th>Thời gian</th><th>Số câu</th><th></th></tr></thead>
              <tbody id="quizzes"><tr><td colspan="5" class="muted">Chọn khóa học để xem đề</td></tr></tbody>
            </table>
          </div>
          <p id="msg" class="muted" style="margin-top:12px"></p>
        </div>

        <div class="card">
          <h2>Tạo đề mới</h2>
          <div class="row">
            <input id="quizTitle" placeholder="Tiêu đề đề kiểm tra"/>
            <input id="quizTime" type="number" min="30" value="600" placeholder="Thời gian (giây)"/>
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="quizShuffle"/>
              <span>Trộn câu hỏi</span>
            </label>
          </div>
          <button class="btn" id="createQuiz" style="margin-top:12px">+ Tạo đề</button>
        </div>

        <div class="card">
          <h2>Thêm câu hỏi</h2>
          <label>Nội dung</label>
          <textarea id="qText" placeholder="Nhập câu hỏi, có thể chèn HTML cơ bản"></textarea>
          <div class="row" style="margin-top:12px">
            <input id="qPoint" type="number" min="1" value="1" placeholder="Điểm"/>
            <div class="row" style="flex:2">
              <input type="file" id="mediaImage" accept="image/*"/>
              <button id="upImg" class="btn ghost">Chèn ảnh</button>
              <input type="file" id="mediaVideo" accept="video/*"/>
              <button id="upVid" class="btn ghost">Chèn video</button>
            </div>
          </div>
          <div class="grid" style="margin-top:16px">
            <div class="option-row">
              <label>Đáp án A</label>
              <div class="row">
                <input id="optA" placeholder="Nội dung đáp án A"/>
                <label style="display:flex;align-items:center;gap:6px">
                  <input type="checkbox" id="correctA"/>
                  Đúng
                </label>
              </div>
            </div>
            <div class="option-row">
              <label>Đáp án B</label>
              <div class="row">
                <input id="optB" placeholder="Nội dung đáp án B"/>
                <label style="display:flex;align-items:center;gap:6px">
                  <input type="checkbox" id="correctB"/>
                  Đúng
                </label>
              </div>
            </div>
            <div class="option-row">
              <label>Đáp án C</label>
              <div class="row">
                <input id="optC" placeholder="Nội dung đáp án C"/>
                <label style="display:flex;align-items:center;gap:6px">
                  <input type="checkbox" id="correctC"/>
                  Đúng
                </label>
              </div>
            </div>
            <div class="option-row">
              <label>Đáp án D</label>
              <div class="row">
                <input id="optD" placeholder="Nội dung đáp án D"/>
                <label style="display:flex;align-items:center;gap:6px">
                  <input type="checkbox" id="correctD"/>
                  Đúng
                </label>
              </div>
            </div>
          </div>
          <button class="btn" id="addQuestion" style="margin-top:16px">+ Thêm câu hỏi</button>
        </div>
      </main>
    </div>
  </div>
</body>
</html>
