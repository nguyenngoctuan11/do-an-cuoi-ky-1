<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Quản lý khóa học</title>
  <link rel="stylesheet" href="/app/app.css"/>
  <script type="module">
    import {mountNav, mountAdminMenu, mountAdminUser, api, requireAuth, qs} from './app-common.js';

    const el = (id) => document.getElementById(id);
    const refs = {
      rows: () => el('courseRows'),
      empty: () => el('courseEmpty'),
      listMsg: () => el('listMsg'),
      banner: () => el('statusBanner')
    };

    const formatPrice = (price)=>{
      if(price === null || price === undefined) return '--';
      try{
        return new Intl.NumberFormat('vi-VN').format(price);
      }catch{
        return price;
      }
    };
    const renderPriceCell = (course)=>{
      const flag = (course?.isFree ?? course?.is_free ?? false) || course?.price == null;
      if(flag){
        return '<div class="badge ok">Miễn phí</div>';
      }
      const money = formatPrice(course.price);
      return `<div class="price-cell"><span class="badge">Pro</span><strong>${money} đ</strong></div>`;
    };

    const statusBadge = (status='')=>{
      const value = status.toLowerCase();
      const tone = value === 'published' ? 'ok' : (value === 'draft' ? '' : 'warning');
      const badgeClass = tone === 'ok' ? 'badge ok' : tone === 'warning' ? 'badge' : 'badge';
      return `<span class="${badgeClass}">${status || '--'}</span>`;
    };

    const renderRow = (course)=>`
      <tr>
        <td>#${course.id}</td>
        <td>
          ${course.thumbnailUrl
            ? `<img class="thumb" src="${course.thumbnailUrl}" alt="${course.title||''}"/>`
            : '<div class="thumb" style="display:flex;align-items:center;justify-content:center;color:var(--text-muted)">--</div>'}
        </td>
        <td>
          <strong>${course.title || '--'}</strong>
          <div class="muted">${course.slug || ''}</div>
        </td>
        <td>${course.shortDesc || '--'}</td>
        <td>${course.language || '--'}</td>
        <td>${course.level || '--'}</td>
        <td>${statusBadge(course.status)}</td>
        <td>${renderPriceCell(course)}</td>
        <td>${course.createdByEmail || '--'}</td>
        <td>
          <div class="row">
            <button class="btn ghost tiny edit-btn" data-id="${course.id}" data-slug="${course.slug||''}">Chỉnh sửa</button>
            <button class="btn ghost tiny danger delete-btn" data-id="${course.id}">Xóa</button>
          </div>
        </td>
      </tr>
    `;

    function maybeShowBanner(){
      const updated = qs('updated');
      if(updated){
        refs.banner().hidden = false;
        refs.banner().textContent = updated === 'created'
          ? 'Đã tạo khóa học mới.'
          : 'Đã cập nhật khóa học.';
        history.replaceState({}, '', location.pathname);
      }
    }

    async function loadCourses(){
      refs.listMsg().textContent = 'Đang tải danh sách...';
      try{
        const list = await api('/api/courses?limit=200');
        if(list.length){
          refs.rows().innerHTML = list.map(renderRow).join('');
          refs.empty().hidden = true;
          refs.rows().querySelectorAll('.edit-btn').forEach(btn => {
            btn.onclick = ()=>{
              const slug = btn.dataset.slug || '';
              location.href = `/app/course.html?id=${btn.dataset.id}&slug=${encodeURIComponent(slug)}`;
            };
          });
          refs.rows().querySelectorAll('.delete-btn').forEach(btn => {
            btn.onclick = ()=> removeCourse(Number(btn.dataset.id));
          });
        }else{
          refs.rows().innerHTML = '';
          refs.empty().hidden = false;
        }
        refs.listMsg().textContent = '';
      }catch(err){
        refs.listMsg().textContent = err.message || err;
      }
    }

    async function removeCourse(id){
      if(!confirm(`Xóa khóa học #${id}?`)) return;
      try{
        await api(`/api/courses/${id}`, { method:'DELETE' });
        loadCourses();
      }catch(err){
        alert(err.message || err);
      }
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      mountNav('nav','sidebar');
      if(!requireAuth(['MANAGER'])) return;
      mountAdminMenu('adminMenu','/app/courses.html');
      mountAdminUser('adminUserCard');
      maybeShowBanner();
      loadCourses();
      el('refreshBtn').onclick = loadCourses;
    });
  </script>
</head>
<body>
  <div class="admin-shell">
    <aside class="admin-sidebar">
      <div id="nav" data-variant="compact"></div>
      <div class="admin-brand">
        <span class="eyebrow">Manager</span>
        <strong>Quản trị nội dung</strong>
      </div>
      <div id="adminMenu" class="admin-menu"></div>
      <div id="adminUserCard" class="admin-user-card"></div>
    </aside>
    <main class="admin-main">
      <div class="admin-page-header">
        <span class="eyebrow">Khóa học</span>
        <h1>Danh sách khóa học</h1>
        <p>Hiển thị đầy đủ thuộc tính (kể cả ảnh), cho phép chỉnh sửa/xóa.</p>
      </div>
      <div id="statusBanner" class="status-banner" hidden></div>

      <section class="card">
        <div class="section-heading">
          <div>
            <h2>Danh sách</h2>
            <p class="muted">Bấm “Chỉnh sửa” để chuyển sang giao diện chỉnh sửa khóa học.</p>
          </div>
          <button class="btn ghost" id="refreshBtn">Làm mới</button>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Ảnh</th>
                <th>Khóa học</th>
                <th>Mô tả ngắn</th>
                <th>Ngôn ngữ</th>
                <th>Level</th>
                <th>Trạng thái</th>
                <th>Loai/Gia</th>
                <th>Người tạo</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody id="courseRows"></tbody>
          </table>
        </div>
        <div id="courseEmpty" class="table-empty" hidden>Chưa có khóa học nào.</div>
        <div id="listMsg" class="muted" style="margin-top:12px;"></div>
      </section>

      <section class="card">
        <h2>Tạo khóa học</h2>
        <p class="muted">Chức năng tạo mới được gom về một trang duy nhất.</p>
        <div class="row">
          <a class="btn" href="/app/admin/teacher-new-course.html">Đi tới trang tạo khóa học</a>
        </div>
      </section>
    </main>
  </div>
</body>
</html>
